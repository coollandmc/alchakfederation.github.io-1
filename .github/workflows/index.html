<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Towns Viewer</title>
  <style>
    :root{--bg:#0b0e16;--muted:#9aa4b2;--accent:#4f46e5}
    body{font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:#e6eef8;margin:0;padding:28px}
    .container{max-width:1100px;margin:0 auto}
    .card{background:linear-gradient(180deg,#0b1220,#0d1626);padding:18px;border-radius:12px;margin-bottom:18px}
    label{display:block;color:var(--muted);margin-bottom:6px}
    select,input,button{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:#071025;color:#dbeafe}
    button{background:linear-gradient(90deg,var(--accent),#2563eb);border:none;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.04);text-align:left}
    th{color:var(--muted);font-weight:600}
    .small{font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>Towns Viewer</h1>
      <p class="small">Loads <code>towns.json</code> (generated by the scraper), filter by nation and days left (max 10). You can trigger the scraper via GitHub Actions by supplying a Personal Access Token (PAT) with repo scope — token is stored in your browser localStorage only.</p>
    </div>

    <div class="card">
      <h2>Filters</h2>
      <label for="nationSelect">Nation</label>
      <select id="nationSelect"><option>Loading...</option></select>

      <label for="daysInput">Show towns under X days (max 10)</label>
      <input id="daysInput" type="number" min="1" max="10" value="10" />

      <div style="margin-top:12px;display:flex;gap:8px">
        <button id="downloadBtn">Download JSON</button>
        <button id="refreshBtn">Refresh / Trigger GH Action</button>
      </div>
    </div>

    <div class="card">
      <h2>Trigger Options</h2>
      <label>GitHub repo owner</label><input id="repoOwner" placeholder="your-github-username" />
      <label>Repo name</label><input id="repoName" placeholder="your-repo" />
      <label>Workflow file path</label><input id="workflowFile" placeholder=".github/workflows/scrape.yml" />
      <label>Personal Access Token (PAT) — stored in localStorage only</label><input id="pat" placeholder="ghp_xxx..." />
      <div class="small">To use the Refresh button without a PAT you'll be redirected to the Actions UI to run manually.</div>
    </div>

    <div class="card">
      <h2>Towns</h2>
      <div class="small" id="meta"></div>
      <table><thead><tr><th>Town</th><th>Nation</th><th>Bank</th><th>Upkeep</th><th>Days</th></tr></thead><tbody id="townsTable"></tbody></table>
    </div>
  </div>

<script>
let data = { towns: [] };
const nationSelect = document.getElementById('nationSelect');
const daysInput = document.getElementById('daysInput');
const townsTable = document.getElementById('townsTable');
const meta = document.getElementById('meta');
const downloadBtn = document.getElementById('downloadBtn');
const refreshBtn = document.getElementById('refreshBtn');
const ownerEl = document.getElementById('repoOwner');
const repoEl = document.getElementById('repoName');
const workflowEl = document.getElementById('workflowFile');
const patEl = document.getElementById('pat');

// load saved settings
ownerEl.value = localStorage.getItem('gh_owner') || '';
repoEl.value = localStorage.getItem('gh_repo') || '';
workflowEl.value = localStorage.getItem('gh_workflow') || '.github/workflows/scrape.yml';
patEl.value = localStorage.getItem('gh_pat') || '';

async function loadJSON(){
  try {
    const r = await fetch('towns.json?cb=' + Date.now());
    if (!r.ok) throw new Error('towns.json not found');
    data = await r.json();
  } catch(e) {
    data = { towns: [] };
    console.warn(e);
  }
  buildNationList();
  render();
}

function buildNationList(){
  const nations = Array.from(new Set(data.towns.map(t => t.nation || '—'))).sort();
  nationSelect.innerHTML = '';
  const all = document.createElement('option'); all.value=''; all.textContent='(All nations)'; nationSelect.appendChild(all);
  for (const n of nations){ const o = document.createElement('option'); o.value=n; o.textContent=n; nationSelect.appendChild(o); }
}

function render(){
  const maxDays = Math.min(10, Math.max(1, Number(daysInput.value) || 10));
  const nation = nationSelect.value;
  const list = data.towns.filter(t => {
    const days = t.days_rounded == null ? Infinity : t.days_rounded;
    if (days > maxDays) return false;
    if (nation && (t.nation || '') !== nation) return false;
    return true;
  }).sort((a,b)=> (a.days_rounded||0) - (b.days_rounded||0));
  townsTable.innerHTML = '';
  for (const t of list){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(t.town)}</td><td>${escapeHtml(t.nation||'—')}</td><td>${t.bank==null?'N/A':numberFormat(t.bank)}</td><td>${t.upkeep==null?'N/A':numberFormat(t.upkeep)}</td><td>${t.days_rounded==null?'∞':t.days_rounded}</td>`;
    townsTable.appendChild(tr);
  }
  meta.textContent = `Loaded ${data.towns.length} towns — showing ${list.length}.`;
}

function escapeHtml(s){ return String(s||'').replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
function numberFormat(n){ return new Intl.NumberFormat().format(n); }

nationSelect.addEventListener('change', render);
daysInput.addEventListener('input', render);

downloadBtn.addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'towns.json'; a.click(); URL.revokeObjectURL(url);
});

refreshBtn.addEventListener('click', async ()=>{
  const owner = ownerEl.value.trim(); const repo = repoEl.value.trim(); const workflow = workflowEl.value.trim(); const pat = patEl.value.trim();
  if (!owner || !repo || !workflow){ alert('Set owner, repo and workflow path'); return; }
  localStorage.setItem('gh_owner', owner); localStorage.setItem('gh_repo', repo); localStorage.setItem('gh_workflow', workflow);
  if (pat) localStorage.setItem('gh_pat', pat);
  if (!pat){ if (confirm('No PAT provided — open Actions page to run manually?')) window.open(`https://github.com/${owner}/${repo}/actions/workflows/${workflow}`); return; }
  try {
    refreshBtn.disabled = true; refreshBtn.textContent = 'Triggering...';
    const api = `https://api.github.com/repos/${owner}/${repo}/actions/workflows/${encodeURIComponent(workflow)}/dispatches`;
    const r = await fetch(api, { method:'POST', headers:{ 'Authorization':'token '+pat, 'Accept':'application/vnd.github+json','Content-Type':'application/json'}, body: JSON.stringify({ ref: 'main' }) });
    if (r.status === 204) alert('Workflow dispatched — check Actions page');
    else { const text = await r.text(); alert('Failed: ' + r.status + ' ' + text); }
  } catch(e){ alert('Error: ' + e.message); }
  finally{ refreshBtn.disabled = false; refreshBtn.textContent = 'Refresh / Trigger GH Action'; }
});

loadJSON();
</script>
</body>
</html>
