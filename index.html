<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Towns Viewer</title>
<style>
:root{--bg:#0b0e16;--muted:#9aa4b2;--accent:#4f46e5}
body{font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:#e6eef8;margin:0;padding:28px}
.container{max-width:1200px;margin:0 auto}
.card{background:linear-gradient(180deg,#0b1220,#0d1626);padding:18px;border-radius:12px;margin-bottom:18px}
label{display:block;color:var(--muted);margin-bottom:6px}
select,input,button{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:#071025;color:#dbeafe}
button{background:linear-gradient(90deg,var(--accent),#2563eb);border:none;cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.04);text-align:left;cursor:default}
th.sortable{cursor:pointer;text-decoration:underline}
th{color:var(--muted);font-weight:600}
tr.low{background:#ff1d1d33}       /* 0-2 days red tint */
tr.medium{background:#ffa62133}    /* 3-5 days orange tint */
tr.high{background:#fffb0033}      /* 6-10 days yellow tint */
.small{font-size:13px;color:var(--muted)}
.pagination{display:flex;gap:8px;align-items:center;margin-top:12px}
.pagination button{padding:6px 10px;font-size:13px}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <h1>Towns Viewer</h1>
    <p class="small">Loads <code>towns.json</code> (generated by the scraper). Filter by nation, days left, search, and pagination. Highlight low-days towns automatically.</p>
  </div>

  <div class="card">
    <h2>Filters</h2>
    <label for="filterMode">Filter mode</label>
    <select id="filterMode">
      <option value="all">Show ALL towns</option>
      <option value="days">Show towns under X days</option>
      <option value="nation">Show towns of selected nation only</option>
      <option value="both">Combined (nation + days)</option>
    </select>

    <label for="nationSelect" id="nationLabel">Nation</label>
    <select id="nationSelect"><option>Loading...</option></select>

    <label for="daysInput" id="daysLabel">Show towns under X days (max 10)</label>
    <input id="daysInput" type="number" min="1" max="10" value="10">

    <label for="searchInput">Search Town</label>
    <input id="searchInput" type="text" placeholder="Type to search...">

    <label for="perPageSelect">Towns per page</label>
    <select id="perPageSelect">
      <option value="25">25</option>
      <option value="50">50</option>
      <option value="75">75</option>
      <option value="100" selected>100</option>
      <option value="all">All</option>
    </select>

    <div style="margin-top:12px;display:flex;gap:8px">
      <button id="downloadBtn">Download JSON</button>
      <button id="refreshBtn">Refresh / Trigger GH Action</button>
    </div>
  </div>

  <div class="card">
    <h2>Trigger Options</h2>
    <label>GitHub repo owner</label><input id="repoOwner" placeholder="your-github-username">
    <label>Repo name</label><input id="repoName" placeholder="your-repo">
    <label>Workflow file path</label><input id="workflowFile" placeholder=".github/workflows/scrape.yml">
    <label>Personal Access Token (PAT) — stored in localStorage only</label><input id="pat" placeholder="ghp_xxx...">
    <div class="small">To use the Refresh button without a PAT you'll be redirected to the Actions UI to run manually.</div>
  </div>

  <div class="card">
    <h2>Towns</h2>
    <div class="small" id="meta"></div>
    <table>
      <thead>
        <tr>
          <th class="sortable" data-key="town">Town</th>
          <th class="sortable" data-key="nation">Nation</th>
          <th class="sortable" data-key="bank">Bank</th>
          <th class="sortable" data-key="upkeep">Upkeep</th>
          <th class="sortable" data-key="days_rounded">Days</th>
        </tr>
      </thead>
      <tbody id="townsTable"></tbody>
    </table>
    <div class="pagination">
      <button id="prevPage">&lt; Prev</button>
      <span id="pageInfo"></span>
      <button id="nextPage">Next &gt;</button>
    </div>
  </div>
</div>

<script>
let data={towns:[]};
let sortKey='days_rounded', sortAsc=true, currentPage=1;
const nationSelect=document.getElementById('nationSelect');
const daysInput=document.getElementById('daysInput');
const townsTable=document.getElementById('townsTable');
const meta=document.getElementById('meta');
const downloadBtn=document.getElementById('downloadBtn');
const refreshBtn=document.getElementById('refreshBtn');
const ownerEl=document.getElementById('repoOwner');
const repoEl=document.getElementById('repoName');
const workflowEl=document.getElementById('workflowFile');
const patEl=document.getElementById('pat');
const filterMode=document.getElementById('filterMode');
const searchInput=document.getElementById('searchInput');
const perPageSelect=document.getElementById('perPageSelect');
const prevPageBtn=document.getElementById('prevPage');
const nextPageBtn=document.getElementById('nextPage');
const pageInfo=document.getElementById('pageInfo');

// load saved settings
ownerEl.value=localStorage.getItem('gh_owner')||'';
repoEl.value=localStorage.getItem('gh_repo')||'';
workflowEl.value=localStorage.getItem('gh_workflow')||'.github/workflows/scrape.yml';
patEl.value=localStorage.getItem('gh_pat')||'';

async function loadJSON(){
  try{
    const r=await fetch('towns.json');
    if(!r.ok) throw new Error('towns.json not found');
    data=await r.json();
  }catch(e){
    data={towns:[]};
    console.warn(e);
  }
  buildNationList();
  updateFilterVisibility();
  render();
}

function buildNationList(){
  const nations=Array.from(new Set(data.towns.map(t=>t.nation||'—'))).sort();
  nationSelect.innerHTML='';
  const all=document.createElement('option'); all.value=''; all.textContent='(All nations)'; nationSelect.appendChild(all);
  for(const n of nations){const o=document.createElement('option'); o.value=n; o.textContent=n; nationSelect.appendChild(o);}
}

function updateFilterVisibility(){
  const mode = filterMode.value;
  document.getElementById('daysLabel').style.display = (mode==='days'||mode==='both')?'block':'none';
  daysInput.style.display = (mode==='days'||mode==='both')?'block':'none';
  document.getElementById('nationLabel').style.display = (mode==='nation'||mode==='both')?'block':'none';
  nationSelect.style.display = (mode==='nation'||mode==='both')?'block':'none';
}

function render(){
  const mode = filterMode.value;
  const search = searchInput.value.toLowerCase();
  let list = data.towns.filter(t=>{
    const days = t.days_rounded == null ? Infinity : t.days_rounded;
    let ok = true;

    if((mode==='days'||mode==='both') && daysInput.style.display!=='none'){
      const maxDays = Math.min(10, Math.max(1, Number(daysInput.value) || 10));
      if(days>maxDays) ok=false;
    }

    if((mode==='nation'||mode==='both') && nationSelect.style.display!=='none'){
      if(nationSelect.value && (t.nation||'')!==nationSelect.value) ok=false;
    }

    if(search && !t.town.toLowerCase().includes(search)) ok=false;
    return ok;
  });

  // Sorting
  list.sort((a,b)=>{
    let va=a[sortKey]||0,vb=b[sortKey]||0;
    if(typeof va==='string') va=va.toLowerCase();
    if(typeof vb==='string') vb=vb.toLowerCase();
    if(va>vb) return sortAsc?1:-1;
    if(va<vb) return sortAsc?-1:1;
    return 0;
  });

  // Pagination
  let perPage = perPageSelect.value==='all'?list.length:Number(perPageSelect.value);
  let totalPages = Math.ceil(list.length/perPage)||1;
  if(currentPage>totalPages) currentPage=totalPages;
  let start = (currentPage-1)*perPage, end = start+perPage;
  let pageList = list.slice(start,end);

  townsTable.innerHTML='';
  for(const t of pageList){
    const tr=document.createElement('tr');
    if(t.days_rounded!=null){
      if(t.days_rounded<=2) tr.classList.add('low');
      else if(t.days_rounded<=5) tr.classList.add('medium');
      else if(t.days_rounded<=10) tr.classList.add('high');
      else if(t.upkeep != null && t.upkeep > 10){
        tr.style.background = '#029c4044'; // subtle green tint
      }
    }
      tr.innerHTML = `
        <td>${escapeHtml(t.town)}</td>
        <td>${escapeHtml(t.nation||'—')}</td>
        <td>${t.bank==null?'N/A':numberFormat(t.bank)}</td>
        <td>${t.upkeep==null?'N/A':numberFormat(t.upkeep)}</td>
        <td>${t.days_rounded==null?'∞':t.days_rounded}</td>`;
  townsTable.appendChild(tr);
}

  meta.textContent=`Loaded ${data.towns.length} towns — showing ${pageList.length}.`;
  pageInfo.textContent=`Page ${currentPage} of ${totalPages}`;
}

function escapeHtml(s){return String(s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));}
function numberFormat(n){return new Intl.NumberFormat().format(n);}

// Event listeners
[nationSelect,daysInput,filterMode,searchInput,perPageSelect].forEach(el=>el.addEventListener('input',()=>{currentPage=1;render();}));
filterMode.addEventListener('change',()=>{updateFilterVisibility(); currentPage=1; render();});

// Pagination buttons
prevPageBtn.addEventListener('click',()=>{if(currentPage>1){currentPage--;render();}});
nextPageBtn.addEventListener('click',()=>{currentPage++;render();});

// Sorting
document.querySelectorAll('th.sortable').forEach(th=>{
  th.addEventListener('click',()=>{
    let key=th.dataset.key;
    if(sortKey===key) sortAsc=!sortAsc; else {sortKey=key; sortAsc=true;}
    render();
  });
});

// Download JSON
downloadBtn.addEventListener('click',()=>{
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='towns.json'; a.click(); URL.revokeObjectURL(url);
});

// Refresh / GitHub Action
refreshBtn.addEventListener('click',async ()=>{
  const owner=ownerEl.value.trim(), repo=repoEl.value.trim(), workflow=workflowEl.value.trim(), pat=patEl.value.trim();
  if(!owner||!repo||!workflow){alert('Set owner, repo and workflow path');return;}
  localStorage.setItem('gh_owner',owner); localStorage.setItem('gh_repo',repo); localStorage.setItem('gh_workflow',workflow);
  if(pat) localStorage.setItem('gh_pat',pat);
  if(!pat){if(confirm('No PAT provided — open Actions page to run manually?'))window.open(`https://github.com/${owner}/${repo}/actions/workflows/${workflow}`);return;}
  try{
    refreshBtn.disabled=true; refreshBtn.textContent='Triggering...';
    const api=`https://api.github.com/repos/${owner}/${repo}/actions/workflows/${encodeURIComponent(workflow)}/dispatches`;
    const r=await fetch(api,{method:'POST',headers:{'Authorization':'token '+pat,'Accept':'application/vnd.github+json','Content-Type':'application/json'},body:JSON.stringify({ref:'main'})});
    if(r.status===204) alert('Workflow dispatched — check Actions page');
    else{const text=await r.text(); alert('Failed: '+r.status+' '+text);}
  }catch(e){alert('Error: '+e.message);}
  finally{refreshBtn.disabled=false; refreshBtn.textContent='Refresh / Trigger GH Action';}
});

loadJSON();
</script>
</body>
</html>
